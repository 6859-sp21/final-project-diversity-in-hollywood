<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Diversity in Hollywood</title>
  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">  
  <script src="https://d3js.org/d3.v5.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Didact Gothic' rel='stylesheet'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <style type="text/css">

    ul {
      background-color: #383838;
      list-style-type: none;
      display:flex;
      justify-content: center;
    }

    ul li {
      display: list-item;
    }

    li a {
      display: block;
      padding: 20px 20px;
    }

    li a:hover {
      background-color: #1a1a1a;
    }

    h1 { 
      color: 	#E6AB02; 
      font-size: 3rem;
      line-height: 1; 
      margin-left: 20px;
      margin-top: 20px;
      margin-bottom: 0px;
      text-align: left; 
    }

    h2 {
      font-size: 1.2rem;
      line-height: 1.2; 
      margin-top: 5px;
      margin-left: 20px;
      text-align: left; 
    }

    body {
      font-family: 'Didact Gothic', sans-serif; 
      background-color: rgb(29, 28, 28);
    }

    #main {
      margin: auto;
      padding: 60px;
      text-align: center;
    }

    #slider-section {
      width: 1000px;
      margin: auto;
      padding-top: 30px;
    }

    #slider-container {
      position: relative;
      height:30px;
    }

    .slider {
      background-color: #E6AB02 !important;
    }

    .handle {
      height: 12px !important;
      width: 12px !important;
      border-color: black !important;
      background-color: black !important;
      border-radius: 10px;
    }

    #graph {
      /* so the graph doesn't go outside of the container on zoom */
      /* overflow: hidden; */
      cursor: pointer;
    }

    #legend {
      text-align: center;
    }

    .legendTitle {
      font-size: 18px;
    }

    .sources {
      font-size: 12px;
    }

    .caption {
      color: white;
      font-size: 15px;
    }

    #zoom {
      color: white;
      transform: translate(75px, 150px);
    }

    .sidebar {	
      text-align: left;			
      color: #E6AB02;		
      font: 18px "Didact Gothic";		
      background: #2C251E;	
      padding: 30px;	
      margin-top: 30px;
      /* pointer-events: none;		 */
      right: 0;
      top: 0;
    }

    body {
      display: flex;
      flex-direction: row;
      color: white;
    }

    text {
        font-family: 'Didact Gothic', sans-serif; 
    }

    #blurb {
        display: flex;
        flex-direction: column;
        padding: 10px;
    }

    .axis line{
        stroke: white;
    }

    .y-axis line{
      stroke: white;
      visibility: hidden;
    }

    .axis path{
        stroke: rgba(0,0,0,0);
    }

    .axis text{
      font-size: 20px;
      text-transform: lowercase;
      /* stroke: white; */
    }

    .legendSize text {
      stroke: white;
      opacity: 100%;
    }

    #container {
      display: flex;
      flex-direction: column;
    }

    #heading {
      display: flex;
      flex-direction: row;
    }

    .nav-option {
      color: #7E5E29 !important;
      font-size: 24px;
      text-decoration: none !important;
      transition: transform .2s !important; 
      display: block;
    }

    .nav-option:hover {
      transform: scale(1.04) !important;
    }

    .explore-section {
      position: absolute;
      bottom: 10%;
    }

    .selected-nav-option {
      display: block;
      color: #E6AB02 !important;
      font-size: 26px;
      font-weight: 600;
      text-decoration: none !important;
      transition: transform .2s !important; 
    }

    .selected-nav-option:hover {
      transform: scale(1.04) !important;
    }

    .white-stroke {
      stroke: white !important;
      stroke-width: 4px !important;
    }

    select {
      background: rgb(29, 28, 28);
      color: white;
      border-color: #555555;
      border-radius: 6px;
    }

  </style>
</head>
<body>
    <!DOCTYPE html>
    <meta charset="utf-8">
    
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v5.js"></script>
    
    <!-- Create a div where the graph will take place -->
    <div class="row w-100">
      <div class="p-4 col-sm-3" style="background-color: #383838;">
        <div id="heading">
          <img src="./images/popcorn.png" width="100" height="100" style="margin: auto 8px;">
          <div id="blurb">
            <h1>reception</h1>
          </div>
        </div>
        <div id="sidebar-tooltip" >
          <h1 class="display-4 px-4 pt-4" style="font-size: 30px; margin: 0;">How is race diversity related to a movie's gross success?</h1>
              <h2>Explore how race diversity relates to gross revenue success across the decades. <i>For each decade, at most 30 of the highest grossing films are shown,
                taken from the top 1000 grossing movies of all time by adjusted lifetime revenue.</i>
                <br/>Hover over circles to examine individual movies, and use the x-axis select to examine a different race's diversity.</h2>
          <div class="sidebar" id="sidebar-default">
           <span style="font-size: 26px;">No movie has been selected.</span> 
           <br/>Hover over a circle on the visualization to see information on its corresponding movie here.
          </div>
        </div>
        <div class="p-3 explore-section">
          <div class="nav-options">
            <a class="nav-option" href="oscars.html">awards</a>
            <a href="reception.html" class="selected-nav-option">reception</a>
            <a href="sources.html" class="nav-option">credits</a>
            <a href="index.html" class="nav-option">back to home</a>
          </div>
        </div>
      </div>
      <div class="col-sm-9">
        <div id="main">
          <div class="d-flex">
            <div id="graph">
              <div style="font-size: 20px;">% 
                <select class="form-select" id="race-select">
                  <option class="percent-cast-race" value="white" selected>white</option>
                  <option value="black">black</option>
                  <option value="hispanic">hispanic</option>
                  <option value="asian">asian</option>
                  <option value="other">other</option>
                </select>
                cast
              </div>
            </div>
            <div>
              <div id="legend"></div>
              <div class="text-left" style="font-size: 18px;">
                Filter by genre:
                <div>
                  <select class="form-select" id="genre-select" multiple style="width: 120px;">
                    <option selected>all</option>
                    <option value="action">action</option>
                    <option value="adventure">adventure</option>
                    <option value="animation">animation</option>
                    <option value="biography">biography</option>
                    <option value="comedy">comedy</option>
                    <option value="crime">crime</option>
                    <option value="drama">drama</option>
                    <option value="family">family</option>
                    <option value="fantasy">fantasy</option>
                    <option value="history">history</option>
                    <option value="horror">horror</option>
                    <option value="musical">musical</option>
                    <option value="romance">romance</option>
                    <option value="sci-fi">sci-fi</option>
                    <option value="thriller">thriller</option>
                    <option value="war">war</option>
                    <option value="western">western</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
   
    
  
  <!-- JAVASCRIPT -->
  <script>

    // sets dimensions
    var margin = {top: 70, right: 60, bottom: 80, left: 90},
        width = 1100 - margin.left - margin.right,
        height = 1000 - margin.top - margin.bottom;
    
    var legendWidth = 300;
    var legendHeight = 400;

    // sets constants
    var goldColor = "#E6AB02"

    // selected x-axis race
    var selectedRace = "white"
    
    // defines graph svg
    var svg = d3.select("#graph")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + (margin.top - 10) + ")");
    
    // defines tooltip div
    var metadataSidebar = d3.select("#sidebar-tooltip").append("div")	
        .attr("class", "sidebar")				
        .style("opacity", 0)
        .style("height", 0);

    // x-position scale
    var x = d3.scaleLinear()
        .domain([0, 1])
        .range([ 0, width ]);
    svg.append("g")
        .attr("transform", "translate(0," + (margin.top-70) + ")")
        .attr("class", "axis")
        .call(d3.axisTop(x).tickFormat(d3.format(".0%")))
        .call(g => g.select(".domain").remove());

    // y-position scale
    var decades = ["1920s", "1930s", "1940s", "1950s", "1960s", "1970s", "1980s", "1990s", "2000s", "2010s"].reverse()
    var y = d3.scaleBand()
        .padding(0.4)
        .domain(decades)
        .range([ height, 0 ]);
    svg.append("g")
        .attr("class", "axis y-axis")
        .call(d3.axisLeft(y).tickPadding([30]))
        .call(g => g.select(".domain").remove());
    // style the y-axis labels to change color on hover
    d3.select('.y-axis')
        .selectAll('.tick')
        .on("mouseover", function(d) {
          d3.select(event.currentTarget).style("color", goldColor).style("stroke", goldColor)

        })
        .on("mouseout", function(d) {
          d3.select(event.currentTarget).style("color", "white").style("stroke", "white")
        })

    // background bars
    svg.selectAll("bar")
      .data(decades)
        .enter()
          .append("rect")
            .style("fill", "#383838")
            .attr("rx", 6)
            .attr("ry", 6)
            .attr("x", 0)
            .attr("width", x(1))
            .attr("y", function(d) { return y(d); })
            .attr("height", y.bandwidth())
    // horizontal lines through background bars
    svg.selectAll("bar")
      .data(decades)
        .enter()
          .append('line')
            .style("stroke", "white")
            .style("stroke-width", 1)
            .style("opacity", 0.15)
            .attr("x1", 0)
            .attr("y1", function(d) {return y(d) + y.bandwidth() / 2})
            .attr("x2", x(1))
            .attr("y2", function(d) {return y(d) + y.bandwidth() / 2})
    // vertical lines through background bars
    var percentWhiteTicks = [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1]
    svg.selectAll("bar")
      .data(percentWhiteTicks)
        .enter()
          .append('line')
            .style("stroke", "rgb(29, 28, 28)")
            .style("stroke-width", 2.5)
            .attr("x1", d => x(d))
            .attr("y1", 0)
            .attr("x2", d => x(d))
            .attr("y2", height)
    
    function nFormatter(num, digits) {
      var si = [
        { value: 1, symbol: "" },
        { value: 1E3, symbol: "k" },
        { value: 1E6, symbol: "M" },
        { value: 1E9, symbol: "B" },
        { value: 1E12, symbol: "T" },
        { value: 1E15, symbol: "P" },
        { value: 1E18, symbol: "E" }
      ];
      var rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
      var i;
      for (i = si.length - 1; i > 0; i--) {
        if (num >= si[i].value) {
          break;
        }
      }
      return (num / si[i].value).toFixed(digits).replace(rx, "$1") + si[i].symbol;
    }

    // radius scale
    var rScale = d3.scaleLinear()
        .domain([0, 2000000000]) // hardset from worldwide gross income max
        .range([2, 20]);

    // size-based legend for revenue
    var legendSvg = d3.select("#legend")
        .append("svg")
            .attr("width", legendWidth)
            .attr("height", legendHeight);
           
    legendSvg.append("g")
        .attr("class", "legendSize")
        .attr("transform", "translate(0,50)")
        .style("fill", goldColor);

    var legendSize = d3.legendSize()
        .scale(rScale)
        .shape('circle')
        .shapePadding(30)
        .labelFormat(d => nFormatter(d,1))
        .labelOffset(20)
        .title('adjusted lifetime revenue ($)')
        .orient('vertical');
    
    legendSvg.select(".legendSize")
        .call(legendSize);

    function getHtmlForSidebar(data) {
      // genre, budget, metascore, gross worldwide / us, percent distribution
      var imageDiv = "<div id='movie-poster' class='pr-4 float-left'><img src='./images/movie-thumbnail.jpg' width='100'/></div>"
      var header = "<h3>" + data.original_title + " (" + data.year + ")" + "</h3>"
      var genre = "<div>Genre: <span class='text-white'>" + data.genre + "</span></div>"
      var budget = "<div>Budget ($): <span class='text-white'>" + nFormatter(data.budget,1) + "</span></div>"
      var metascore = "<div>IMDB metascore: <span class='text-white'>" + data.metascore + "/100</span></div>"
      var gross = "<div>Adjusted lifetime revenue ($): <span class='text-white'>" + nFormatter(data.adjusted_lifetime_gross, 1) + "</div>"
      var breaks = "<br><br>"
      var diversityText = "<div> Of the <a href='https://en.wikipedia.org/wiki/Billing_(performing_arts)#Top_and_above-title_billing' target='_blank'>top-billed</a> actors in the film, the race distribution was: </div>"
      var tooltipDiv = "<div id='summaryBars' class='text-center'></div>"
      return imageDiv + header + genre + budget + metascore + gross + breaks + diversityText + tooltipDiv
    }

    async function getMoviePoster(movieTitle) {
      let response = await fetch('https://api.themoviedb.org/3/search/movie?api_key=75df43b925430c7c3bf191157cc3d9ea&query=' + movieTitle)
      let json = await response.json()
      return json.results[0].poster_path
    }

    var update = function(input_data, all_data, decadePrefix, yAxis) {
      var data = input_data
      if (decadePrefix !== null) {
        // if there's a decade prefix, then we're in the expanded view and we want
        // to filter to max 30 movies per YEAR instead of per DECADE
        var data = []
        for (let i = 0; i < 10; i++) {
          var moviesInYear = all_data.filter(d => d.year == decadePrefix + i)
          // sort movies by gross
          moviesInYear.sort((a,b) => (a.adjusted_lifetime_gross < b.adjusted_lifetime_gross) ? 1 : -1)
          data.push(...moviesInYear.slice(0,30)) // take top 30 movies
        }
      }
      // add scatterplot dots
      var node = svg
      .selectAll(".graph-circle")
      .data(data, d => d)
      
      node.join(
        enter => enter.append("circle")
        .attr("class", "graph-circle")
        .attr("cx", d => x(d.percent_white))
        .attr("cy", d => {return y(d.year.substring(0,3) + "0s") + y.bandwidth() / 2})
        .attr("r", d => rScale(parseFloat(d.adjusted_lifetime_gross)))
        .style("fill", goldColor)
        .style("stroke", "#383838")
        .style("stroke-width", 1.5)
        .on("mouseover", function(d) {
            var sidebarDefault = document.getElementById('sidebar-default')
            if (sidebarDefault) {sidebarDefault.remove()}
            // remove the stroke from the previous hovered circle
            var el = document.getElementsByClassName("white-stroke");
            for (let i = 0; i < el.length; i++) {
              el[i].classList.remove("white-stroke")
            }

            d3.select(this).classed('white-stroke', true)

            metadataSidebar.transition()		
                .duration(200)		
                .style("opacity", 1)
                .style("height", "auto");		
            metadataSidebar.html(
              getHtmlForSidebar(d)
            );
            var y = d3.scaleBand().padding(0.2).domain(["white", "black", "hispanic", "asian", "other"]).range([0,280])
            var x = d3.scaleLinear().domain([0, 1]).range([0,260]);
            
            var barTipSVG = d3.select("#summaryBars")
              .append("svg")
              .attr("width", 420)
              .attr("height", 280); 
            
            barTipSVG.append("g")
              .attr("transform", "translate(85,0)")
              .attr("class", "axis")
              .attr("opacity", 0)
              .call(d3.axisBottom(x))
              .call(g => g.select(".domain").remove());
            
            barTipSVG.append("g")
              .attr("transform", "translate(87,0)")
              .attr("class", "axis")
              .call(d3.axisLeft(y))
              .call(g => g.select(".domain").remove());

            var race_distribution = [
              {"race": "white", "percent": d.percent_white},
              {"race": "black", "percent": d.percent_black},
              {"race": "hispanic", "percent": d.percent_hispanic},
              {"race": "asian", "percent": d.percent_asian},
              {"race": "other", "percent": d.percent_other},
            ]

            barTipSVG
              .selectAll("bar")
              .data(race_distribution, d => d.race)
              .enter()
              .append("rect")
                .attr("transform", "translate(85,0)")
                .style("fill", goldColor)
                .attr("x", function(d) { return x(0); })
                .attr("width", 0)
                .attr("y", function(d) { return y(d.race); })
                .attr("height", y.bandwidth())
                .transition() // <---- Here is the transition
                .duration(500)
                .attr("width", function(d) { return x(d.percent); });
            
            // add labels
            barTipSVG.selectAll(".bar-label")
              .data(race_distribution, d => d.race)
              .enter()
              .append('text')
                .attr("transform", "translate(85,0)")
                .text(function(d) { 
                  return (d.percent * 100).toFixed(1) + "%";
                })
                .attr("y", function(d){
                  return y(d.race) + y.bandwidth() / 2 + 4;
                })
                .attr("x", function(d){
                  return x(d.percent) + 27;
                })
                .attr("fill", "white")
                .attr("text-anchor", "middle");
            
            // add movie poster
            getMoviePoster(d.original_title).then(path => {
              var el = d3.select("#movie-poster")
              el.innerHTML = ""
              const imagePath = 'https://image.tmdb.org/t/p/original' + path
              el.select('img')
                .attr('src', imagePath)
                .attr('width', 100)
            })
        })
        .on("mouseout", function(d) {		
            // metadataSidebar.transition()		
            //     .duration(300)		
            //     .style("opacity", 0)
            //     .style("height", "0px");	
        }),
        update => update,
        exit => exit.remove()
      )

      // physics for dots along the line
      // Features of the forces applied to the nodes:
      var simulation = d3.forceSimulation()
          .force('x', d3.forceX().x(function(d) {
            var raceToField = {
              "white": d.percent_white,
              "black": d.percent_black,
              "asian": d.percent_asian,
              "hispanic": d.percent_hispanic,
              "other": d.percent_other
            }
            return x(raceToField[selectedRace]);
          }).strength(0.4))
          .force('y', d3.forceY().y(function(d) {
            if (decadePrefix !== null) {
              // send to individual years within the decade
              return yAxis(d.year) + yAxis.bandwidth() / 2;
            } else {
              return yAxis(d.year.substring(0,3) + "0s") + yAxis.bandwidth() / 2;
            }
          }).strength(function(d) {
            if (decadePrefix !== null) {
              return 5
            } else {
              return 0.8
            }
          }))
          .force('charge', d3.forceManyBody().strength(function(d) {
            if (decadePrefix !== null) {
              return 0
            } else {
              return 3
            }
          }))
          .force('collision', d3.forceCollide().radius(function(d) {
            return rScale(parseFloat(d.adjusted_lifetime_gross));
          }))
      var node = svg.selectAll('.graph-circle')

      // Apply these forces to the nodes and update their positions.
      // Once the force algorithm is happy with positions ('alpha' value is low enough), simulations will stop.
      simulation
          .nodes(data)
          .on("tick", function(d){
            node
                .attr("cx", function(d){ return d.x; })
                .attr("cy", function(d){ return d.y; })
          }); 
      
      simulation.nodes(data).alpha(0.3).alphaTarget(0).restart()

      // change the y-axis range to zoom in on a decade
      
      d3.select('.y-axis')
        .selectAll('.tick')
        .attr('class', d => d)
        // .on('click', d => ())
      
      // event listeners for race button filter clicks
      var updateSelectedRace = function(race, data) {
          selectedRace = race
          // draw average line
          var sum = d3.sum(data, function(d) { 
            var raceToField = {
              "white": d.percent_white,
              "black": d.percent_black,
              "asian": d.percent_asian,
              "hispanic": d.percent_hispanic,
              "other": d.percent_other
            }
            return raceToField[selectedRace] 
          }); 
          var average = sum / data.length

          var lineNode = svg
          .append("g")
          .selectAll(".avg-line")
          .data([average])

          if (document.getElementById("avg-line")) {
            document.getElementById("avg-line").remove()
          }
          if (document.getElementById("avg-caption")) {
            document.getElementById("avg-caption").remove()
          }

          lineNode.join(
            enter => enter.append('line')
              .attr("id", "avg-line")
              .style("stroke", "white")
              .style("stroke-width", 1)
              .attr("x1", avg => x(avg))
              .attr("y1", y("1920s"))
              .attr("x2", avg => x(avg))
              .attr("y2", y("2010s") + y.bandwidth()),
            update => update,
            exit => exit.remove()
          )

          lineNode.join(
            enter => enter.append("text")
              .attr("id", "avg-caption")
              .attr("transform", function(d) {
                var xTranslation = x(average) + 130
                var yTranslation = y("2010s") + y.bandwidth() + 20
                return "translate(" + xTranslation + "," + yTranslation + ")"})
              .attr("text-anchor", "end")
              .style("fill", "white")
              .style("font-size", "18px")
              .html("Average % " + selectedRace + " cast: " + (average * 100).toFixed(1)),
            update => update,
            exit => exit.remove()
          )


          // simulation
          simulation.force('x', d3.forceX().x(function(d) {
            var raceToField = {
              "white": d.percent_white,
              "black": d.percent_black,
              "asian": d.percent_asian,
              "hispanic": d.percent_hispanic,
              "other": d.percent_other
            }
            return x(raceToField[race]);
          }).strength(0.4)).alpha(0.2).alphaTarget(0).restart()
      }

      updateSelectedRace(selectedRace, data)

      const raceSelect = document.querySelector('#race-select');
      raceSelect.addEventListener('change', (event) => {
        updateSelectedRace(event.target.value, data)
      });
    }
    
    d3.csv("./datasets/movie_distributions_top_1000_gross.csv").then((all_data) => {
      // parse the data
      for (i = 0; i < all_data.length; i++) {
        all_data[i].budget = parseFloat(all_data[i].budget.replace('$', ''));
        all_data[i].usa_gross_income = parseFloat(all_data[i].usa_gross_income.replace('$', ''));
        all_data[i].adjusted_lifetime_gross = parseFloat(all_data[i].adjusted_lifetime_gross.substring(1,).replace(/,/g, ''));
      }

      // filter out top 30 per decade
      var filterTop30PerDecade = function(dataset) {
        var data = []
        for (let i = 0; i < decades.length; i++) {
          var decadePrefix = decades[i].substring(0,3)
          var moviesInDecade = dataset.filter(d => d.year.substring(0,3) == decadePrefix)
          // sort movies by gross
          moviesInDecade.sort((a,b) => (a.adjusted_lifetime_gross < b.adjusted_lifetime_gross) ? 1 : -1)
          data.push(...moviesInDecade.slice(0,30)) // take top 30 movies
        } 
        return data
      }

      var data = filterTop30PerDecade(all_data)
      
      const genreSelect = document.querySelector('#genre-select');
      genreSelect.addEventListener('change', (event) => {
        var selectedGenres =$("#genre-select").val();
        var newData = all_data
        if (!selectedGenres.includes("all")) {
          var newData = all_data.filter(d => {
          var dataGenres = d.genre.split(",");
          for (let i = 0; i < dataGenres.length; i++) {
            if (selectedGenres.includes(dataGenres[i].toLowerCase().trim())) {
              return true
            }
          }
          return false
        })
        }
        // filter out to 30 max per decade
        var filteredNewData = filterTop30PerDecade(newData)
        update(filteredNewData, all_data, null, y)
      });
  
      update(data, all_data, null, y)
    })
    

    </script>
</body>