<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Diversity in Hollywood</title>
  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">  
  <script src="https://d3js.org/d3.v5.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Didact Gothic' rel='stylesheet'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <style type="text/css">

    ul {
      background-color: #383838;
      list-style-type: none;
      display:flex;
      justify-content: center;
    }

    ul li {
      display: list-item;
    }

    li a {
      display: block;
      padding: 20px 20px;
    }

    li a:hover {
      background-color: #1a1a1a;
    }

    h1 { 
      color: 	#E6AB02; 
      font-size: 3rem;
      line-height: 1; 
      margin-left: 20px;
      margin-top: 20px;
      margin-bottom: 0px;
      text-align: left; 
    }

    h2 {
      font-size: 1.2rem;
      line-height: 1; 
      margin-top: 5px;
      margin-left: 20px;
      text-align: left; 
    }

    body {
      font-family: 'Didact Gothic', sans-serif; 
      background-color: rgb(29, 28, 28);
    }

    #main {
      margin: auto;
      padding: 60px;
      text-align: center;
    }

    #slider-section {
      width: 1000px;
      margin: auto;
      padding-top: 30px;
    }

    #slider-container {
      position: relative;
      height:30px;
    }

    .slider {
      background-color: #E6AB02 !important;
    }

    .handle {
      height: 12px !important;
      width: 12px !important;
      border-color: black !important;
      background-color: black !important;
      border-radius: 10px;
    }

    #graph {
      /* so the graph doesn't go outside of the container on zoom */
      /* overflow: hidden; */
      cursor: pointer;
    }

    #legend {
      text-align: center;
    }

    .legendTitle {
      font-size: 18px;
    }

    .sources {
      font-size: 12px;
    }

    .caption {
      color: white;
      font-size: 15px;
    }

    #zoom {
      color: white;
      transform: translate(75px, 150px);
    }

    .sidebar {	
      text-align: left;			
      color: #E6AB02;		
      font: 18px "Didact Gothic";		
      background: #2C251E;	
      padding: 30px;	
      margin-top: 30px;
      /* pointer-events: none;		 */
      right: 0;
      top: 0;
    }

    body {
      display: flex;
      flex-direction: row;
      color: white;
    }

    text {
        font-family: 'Didact Gothic', sans-serif; 
    }

    #blurb {
        display: flex;
        flex-direction: column;
        padding: 10px;
    }

    .axis line{
        stroke: white;
    }

    .y-axis line{
      stroke: white;
      visibility: hidden;
    }

    .axis path{
        stroke: rgba(0,0,0,0);
    }

    .axis text{
      font-size: 20px;
      text-transform: lowercase;
      /* stroke: white; */
    }

    .legendSize text {
      stroke: white;
      opacity: 100%;
    }

    #container {
      display: flex;
      flex-direction: column;
    }

    #heading {
      display: flex;
      flex-direction: row;
    }

    .nav-option {
      color: #7E5E29 !important;
      font-size: 24px;
      text-decoration: none !important;
      transition: transform .2s !important; 
      display: block;
    }

    .nav-option:hover {
      transform: scale(1.04) !important;
    }

    .explore-section {
      position: absolute;
      bottom: 10%;
    }

    .selected-nav-option {
      display: block;
      color: #E6AB02 !important;
      font-size: 26px;
      font-weight: 600;
      text-decoration: none !important;
      transition: transform .2s !important; 
    }

    .selected-nav-option:hover {
      transform: scale(1.04) !important;
    }

    .white-fill {
      fill: white !important;
    }

  </style>
</head>
<body>
    <!DOCTYPE html>
    <meta charset="utf-8">
    
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v5.js"></script>
    
    <!-- Create a div where the graph will take place -->
    <div class="row w-100">
      <div class="p-4 col-sm-3" style="background-color: #383838;">
        <div id="heading">
          <img src="./images/popcorn.png" width="100" height="100" style="margin: auto 8px;">
          <div id="blurb">
            <h1>reception</h1>
          </div>
        </div>
        <div id="sidebar-tooltip" >
          <h1 class="display-4 px-4 pt-4" style="font-size: 30px; margin: 0;">How is race diversity related to a movie's box office success?</h1>
              <h2>By examining the top 30 grossing movies from each decade, we can explore race diversity vs. metrics of reception.
              Hover over circles to see more information about individual movies.</h2>
          <div class="sidebar" id="sidebar-default">
            No movie has been selected. Hover over a circle to see additional information on the movie here.
          </div>
        </div>
        <div class="p-3 explore-section">
          <div class="nav-options">
            <a class="nav-option" href="oscars.html">awards</a>
            <a href="reception.html" class="selected-nav-option">reception</a>
            <a href="index.html" class="nav-option">back to home</a>
          </div>
        </div>
      </div>
      <div class="col-sm-9">
        <div id="main">
          <div class="d-flex justify-content-around text-center px-5">
            <div class="py-4 my-auto">
              Change x-axis: 
              <button type="button" class="btn btn-light percent-cast-race" id="white-button">white</button>
              <button type="button" class="btn btn-outline-light percent-cast-race" id="black-button">black</button>
              <button type="button" class="btn btn-outline-light percent-cast-race" id="hispanic-button">hispanic</button>
              <button type="button" class="btn btn-outline-light percent-cast-race" id="asian-button">asian</button>
              <button type="button" class="btn btn-outline-light percent-cast-race" id="other-button">other</button>
            </div>
            <div id="legend"></div>
          </div>
          <div id="graph"></div>
        </div>
      </div>
    </div>
   
    
  
  <!-- JAVASCRIPT -->
  <script>

    // sets dimensions
    var margin = {top: 70, right: 60, bottom: 80, left: 90},
        width = 1100 - margin.left - margin.right,
        height = 1000 - margin.top - margin.bottom;
    
    var legendWidth = 300;
    var legendHeight = 150;

    // sets constants
    var goldColor = "#E6AB02"

    // selected x-axis race
    var selectedRace = "white"
    
    // defines graph svg
    var svg = d3.select("#graph")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");
    
    // defines tooltip div
    var metadataSidebar = d3.select("#sidebar-tooltip").append("div")	
        .attr("class", "sidebar")				
        .style("opacity", 0)
        .style("height", 0);

    // x-position scale
    var x = d3.scaleLinear()
        .domain([0, 1])
        .range([ 0, width ]);
    svg.append("g")
        .attr("transform", "translate(0," + (margin.top-70) + ")")
        .attr("class", "axis")
        .call(d3.axisTop(x))
        .call(g => g.select(".domain").remove());

    svg.append("text")             
        .attr("transform",
            "translate(" + (width/2) + " ," + 
                        (margin.top - 120) + ")")
        .attr("id", "x-axis-label")
        .style("text-anchor", "middle")
        .style("stroke", "white")
        .style("font-size", "20px")
        .text("% " + selectedRace + " cast");

    // y-position scale
    var decades = ["1920s", "1930s", "1940s", "1950s", "1960s", "1970s", "1980s", "1990s", "2000s", "2010s"].reverse()
    var y = d3.scaleBand()
        .padding(0.4)
        .domain(decades)
        .range([ height, 0 ]);
    svg.append("g")
        .attr("class", "axis y-axis")
        .call(d3.axisLeft(y).tickPadding([30]))
        .call(g => g.select(".domain").remove());
    // style the y-axis labels to change color on hover
    d3.select('.y-axis')
        .selectAll('.tick')
        .on("mouseover", function(d) {
          d3.select(event.currentTarget).style("color", goldColor).style("stroke", goldColor)

        })
        .on("mouseout", function(d) {
          d3.select(event.currentTarget).style("color", "white").style("stroke", "white")
        })

    // background bars
    svg.selectAll("bar")
      .data(decades)
        .enter()
          .append("rect")
            .style("fill", "#383838")
            .attr("rx", 6)
            .attr("ry", 6)
            .attr("x", 0)
            .attr("width", x(1))
            .attr("y", function(d) { return y(d); })
            .attr("height", y.bandwidth())
    // horizontal lines through background bars
    svg.selectAll("bar")
      .data(decades)
        .enter()
          .append('line')
            .style("stroke", "white")
            .style("stroke-width", 1)
            .style("opacity", 0.15)
            .attr("x1", 0)
            .attr("y1", function(d) {return y(d) + y.bandwidth() / 2})
            .attr("x2", x(1))
            .attr("y2", function(d) {return y(d) + y.bandwidth() / 2})
    // vertical lines through background bars
    var percentWhiteTicks = [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1]
    svg.selectAll("bar")
      .data(percentWhiteTicks)
        .enter()
          .append('line')
            .style("stroke", "rgb(29, 28, 28)")
            .style("stroke-width", 2.5)
            .attr("x1", d => x(d))
            .attr("y1", 0)
            .attr("x2", d => x(d))
            .attr("y2", height)
    
    function nFormatter(num, digits) {
      var si = [
        { value: 1, symbol: "" },
        { value: 1E3, symbol: "k" },
        { value: 1E6, symbol: "M" },
        { value: 1E9, symbol: "B" },
        { value: 1E12, symbol: "T" },
        { value: 1E15, symbol: "P" },
        { value: 1E18, symbol: "E" }
      ];
      var rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
      var i;
      for (i = si.length - 1; i > 0; i--) {
        if (num >= si[i].value) {
          break;
        }
      }
      return (num / si[i].value).toFixed(digits).replace(rx, "$1") + si[i].symbol;
    }

    // radius scale
    var rScale = d3.scaleLinear()
        .domain([0, 2000000000]) // hardset from worldwide gross income max
        .range([2, 20]);

    // size-based legend for revenue
    var legendSvg = d3.select("#legend")
        .append("svg")
            .attr("width", legendWidth)
            .attr("height", legendHeight);
           
    legendSvg.append("g")
        .attr("class", "legendSize")
        .attr("transform", "translate(0, 50)")
        .style("fill", goldColor);

    var legendSize = d3.legendSize()
        .scale(rScale)
        .shape('circle')
        .shapePadding(60)
        .labelFormat(d => nFormatter(d,1))
        .labelOffset(20)
        .title('adjusted lifetime revenue ($)')
        .orient('horizontal');
    
    legendSvg.select(".legendSize")
        .call(legendSize);

    function getHtmlForSidebar(data) {
      // genre, budget, metascore, gross worldwide / us, percent distribution
      var imageDiv = "<div id='movie-poster' class='pr-4 float-left'><img src='./images/movie-thumbnail.jpg' width='100'/></div>"
      var header = "<h3>" + data.original_title + " (" + data.year + ")" + "</h3>"
      var genre = "<div>Genre: " + data.genre + "</div>"
      var budget = "<div>Budget: " + nFormatter(data.budget,1) + "</div>"
      var metascore = "<div>IMDB metascore: " + data.metascore + "/100</div>"
      var gross = "<div>Worldwide gross revenue: " + nFormatter(data.adjusted_lifetime_gross, 1) + "</div>"
      var breaks = "<br><br>"
      var diversityText = "<div> Of the <a href='https://en.wikipedia.org/wiki/Billing_(performing_arts)#Top_and_above-title_billing' target='_blank'>top-billed</a> actors in the film, the race distribution was: </div>"
      var tooltipDiv = "<div id='summaryBars' class='text-center'></div>"
      return imageDiv + header + genre + budget + metascore + gross + breaks + diversityText + tooltipDiv
    }

    async function getMoviePoster(movieTitle) {
      let response = await fetch('https://api.themoviedb.org/3/search/movie?api_key=75df43b925430c7c3bf191157cc3d9ea&query=' + movieTitle)
      let json = await response.json()
      return json.results[0].poster_path
    }

    var update = function(input_data, all_data, decadePrefix, yAxis) {
      var data = input_data
      if (decadePrefix !== null) {
        // if there's a decade prefix, then we're in the expanded view and we want
        // to filter to max 30 movies per YEAR instead of per DECADE
        var data = []
        for (let i = 0; i < 10; i++) {
          var moviesInYear = all_data.filter(d => d.year == decadePrefix + i)
          // sort movies by gross
          moviesInYear.sort((a,b) => (a.adjusted_lifetime_gross < b.adjusted_lifetime_gross) ? 1 : -1)
          data.push(...moviesInYear.slice(0,30)) // take top 30 movies
        }
      }
      // add scatterplot dots
      var node = svg
      .selectAll(".graph-circle")
      .data(data, d => d)
      
      node.join(
        enter => enter.append("circle")
        .attr("class", "graph-circle")
        .attr("cx", d => x(d.percent_white))
        .attr("cy", d => {return y(d.year.substring(0,3) + "0s") + y.bandwidth() / 2})
        .attr("r", d => rScale(parseFloat(d.adjusted_lifetime_gross)))
        .style("fill", goldColor)
        .style("stroke", "#383838")
        .style("stroke-width", 1.5)
        .on("mouseover", function(d) {
            var sidebarDefault = document.getElementById('sidebar-default')
            if (sidebarDefault) {sidebarDefault.remove()}
            // remove the stroke from the previous hovered circle
            var el = document.getElementsByClassName("white-fill");
            for (let i = 0; i < el.length; i++) {
              el[i].classList.remove("white-fill")
            }

            d3.select(this).classed('white-fill', true)

            metadataSidebar.transition()		
                .duration(200)		
                .style("opacity", 1)
                .style("height", "auto");		
            metadataSidebar.html(
              getHtmlForSidebar(d)
            );
            var y = d3.scaleBand().padding(0.2).domain(["white", "black", "hispanic", "asian", "other"]).range([0,280])
            var x = d3.scaleLinear().domain([0, 1]).range([0,260]);
            
            var barTipSVG = d3.select("#summaryBars")
              .append("svg")
              .attr("width", 420)
              .attr("height", 280); 
            
            barTipSVG.append("g")
              .attr("transform", "translate(85,0)")
              .attr("class", "axis")
              .attr("opacity", 0)
              .call(d3.axisBottom(x))
              .call(g => g.select(".domain").remove());
            
            barTipSVG.append("g")
              .attr("transform", "translate(87,0)")
              .attr("class", "axis")
              .call(d3.axisLeft(y))
              .call(g => g.select(".domain").remove());

            var race_distribution = [
              {"race": "white", "percent": d.percent_white},
              {"race": "black", "percent": d.percent_black},
              {"race": "hispanic", "percent": d.percent_hispanic},
              {"race": "asian", "percent": d.percent_asian},
              {"race": "other", "percent": d.percent_other},
            ]

            barTipSVG
              .selectAll("bar")
              .data(race_distribution, d => d.race)
              .enter()
              .append("rect")
                .attr("transform", "translate(85,0)")
                .style("fill", goldColor)
                .attr("x", function(d) { return x(0); })
                .attr("width", 0)
                .attr("y", function(d) { return y(d.race); })
                .attr("height", y.bandwidth())
                .transition() // <---- Here is the transition
                .duration(500)
                .attr("width", function(d) { return x(d.percent); });
            
            // add labels
            barTipSVG.selectAll(".bar-label")
              .data(race_distribution, d => d.race)
              .enter()
              .append('text')
                .attr("transform", "translate(85,0)")
                .text(function(d) { 
                  return (d.percent * 100).toFixed(1) + "%";
                })
                .attr("y", function(d){
                  return y(d.race) + y.bandwidth() / 2 + 4;
                })
                .attr("x", function(d){
                  return x(d.percent) + 27;
                })
                .attr("fill", "white")
                .attr("text-anchor", "middle");
            
            // add movie poster
            getMoviePoster(d.original_title).then(path => {
              var el = d3.select("#movie-poster")
              el.innerHTML = ""
              const imagePath = 'https://image.tmdb.org/t/p/original' + path
              el.select('img')
                .attr('src', imagePath)
                .attr('width', 100)
            })
        })
        .on("mouseout", function(d) {		
            // metadataSidebar.transition()		
            //     .duration(300)		
            //     .style("opacity", 0)
            //     .style("height", "0px");	
        }),
        update => update,
        exit => exit.remove()
      )

      // physics for dots along the line
      // Features of the forces applied to the nodes:
      var simulation = d3.forceSimulation()
          .force('x', d3.forceX().x(function(d) {
            var raceToField = {
              "white": d.percent_white,
              "black": d.percent_black,
              "asian": d.percent_asian,
              "hispanic": d.percent_hispanic,
              "other": d.percent_other
            }
            return x(raceToField[selectedRace]);
          }).strength(0.4))
          .force('y', d3.forceY().y(function(d) {
            if (decadePrefix !== null) {
              // send to individual years within the decade
              return yAxis(d.year) + yAxis.bandwidth() / 2;
            } else {
              return yAxis(d.year.substring(0,3) + "0s") + yAxis.bandwidth() / 2;
            }
          }).strength(function(d) {
            if (decadePrefix !== null) {
              return 5
            } else {
              return 0.8
            }
          }))
          .force('charge', d3.forceManyBody().strength(function(d) {
            if (decadePrefix !== null) {
              return 0
            } else {
              return 3
            }
          }))
          .force('collision', d3.forceCollide().radius(function(d) {
            return rScale(parseFloat(d.adjusted_lifetime_gross));
          }))
      var node = svg.selectAll('.graph-circle')

      // Apply these forces to the nodes and update their positions.
      // Once the force algorithm is happy with positions ('alpha' value is low enough), simulations will stop.
      simulation
          .nodes(data)
          .on("tick", function(d){
            node
                .attr("cx", function(d){ return d.x; })
                .attr("cy", function(d){ return d.y; })
          }); 
      
      simulation.nodes(data).alpha(0.3).alphaTarget(0).restart()

      // change the y-axis range to zoom in on a decade
      var expandDecade = function(datum) {
        // for now, just expand to 2010s
        var newDecadePrefix = datum.substring(0,3)
        var new_data = data.filter(d => d.year.substring(0,3) == newDecadePrefix)
        // change the axis
        // remove the old axis first
        svg.select(".y-axis").remove()
        var numbers = [9,8,7,6,5,4,3,2,1,0]
        var newDomain = numbers.map( n => newDecadePrefix + n)
        var y = d3.scaleBand()
            .padding(0.4)
            .domain(newDomain)
            .range([ height, 0 ]);
        svg.append("g")
            .attr("class", "axis y-axis")
            .call(d3.axisLeft(y))
            .call(g => g.select(".domain").remove());
        y.domain(newDomain)
        svg.select(".y-axis")
          .transition().duration(1000)
          // .call(g => g.select(".domain").remove())
          .call(d3.axisLeft(y));
        update(new_data, all_data, newDecadePrefix, y)
        // simulation.nodes(new_data).alpha(0.2).alphaTarget(0).restart()
      }
      
      d3.select('.y-axis')
        .selectAll('.tick')
        .attr('class', d => d)
        .on('click', d => expandDecade(d))

      
      // event listeners for race button filter clicks
      var updateSelectedRace = function(race) {
        return function updateRace(e) {
          selectedRace = race
          // update axis
          document.getElementById("x-axis-label").innerHTML = "% " + race + " cast";

          // update button styling
          var els = document.getElementsByClassName("percent-cast-race")
          for (el of els){
              el.classList.remove('btn-light');
              el.classList.add('btn-outline-light');
          }
          document.getElementById(race + "-button").classList.remove('btn-outline-light')
          document.getElementById(race + "-button").classList.add('btn-light')

          // simulation
          simulation.force('x', d3.forceX().x(function(d) {
            var raceToField = {
              "white": d.percent_white,
              "black": d.percent_black,
              "asian": d.percent_asian,
              "hispanic": d.percent_hispanic,
              "other": d.percent_other
            }
            return x(raceToField[race]);
          }).strength(0.4)).alpha(0.2).alphaTarget(0).restart()
        }
      }

      var raceFilters = document.getElementsByClassName("percent-cast-race")
      for (var i = 0; i < raceFilters.length; i++) {
        document.getElementById(raceFilters[i].innerText+"-button").addEventListener("click", updateSelectedRace(raceFilters[i].innerText))
      }

    }
    
    d3.csv("./datasets/movie_distributions_top_1000_gross.csv").then((all_data) => {
      // filter out top 50 per decade
      var data = []
      for (let i = 0; i < decades.length; i++) {
        var decadePrefix = decades[i].substring(0,3)
        var moviesInDecade = all_data.filter(d => d.year.substring(0,3) == decadePrefix)
        // sort movies by gross
        moviesInDecade.sort((a,b) => (a.adjusted_lifetime_gross < b.adjusted_lifetime_gross) ? 1 : -1)
        data.push(...moviesInDecade.slice(0,30)) // take top 30 movies
      }      

      // parse the data
      for (i = 0; i < data.length; i++) {
          data[i].budget = parseFloat(data[i].budget.replace('$', ''));
          data[i].usa_gross_income = parseFloat(data[i].usa_gross_income.replace('$', ''));
          data[i].adjusted_lifetime_gross = parseFloat(data[i].adjusted_lifetime_gross.substring(1,).replace(/,/g, ''));
      }
      update(data, all_data, null, y)


    })
    

    </script>
</body>