<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Diversity in Hollywood</title>
  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">  
  <script src="https://d3js.org/d3.v5.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Didact Gothic' rel='stylesheet'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <style type="text/css">

    ul {
      background-color: #383838;
      list-style-type: none;
      display:flex;
      justify-content: center;
    }

    ul li {
      display: list-item;
    }

    li a {
      display: block;
      padding: 20px 20px;
      color: white;
    }

    li a:hover {
      background-color: #1a1a1a;
    }

    h1 { 
      color: 	#E6AB02; 
      font-size: 3rem;
      line-height: 1; 
      margin-left: 20px;
      margin-top: 20px;
      margin-bottom: 0px;
      text-align: left; 
    }

    h2 {
      color: white; 
      font-size: 1.2rem;
      line-height: 1; 
      margin-top: 5px;
      margin-left: 20px;
      text-align: left; 
    }

    body {
      font-family: 'Didact Gothic', sans-serif; 
      background-color: rgb(29, 28, 28);
    }

    #main {
      margin: auto;
      width: 70%;
    }

    #slider-section {
      width: 1000px;
      margin: auto;
      padding-top: 30px;
    }

    #slider-container {
      position: relative;
      height:30px;
    }

    .slider {
      background-color: #E6AB02 !important;
    }

    .handle {
      height: 12px !important;
      width: 12px !important;
      border-color: black !important;
      background-color: black !important;
      border-radius: 10px;
    }

    #graph {
      /* so the graph doesn't go outside of the container on zoom */
      /* overflow: hidden; */
      cursor: pointer;
    }

    #legend {
      text-align: center;
    }

    .sources {
      color: white;
      font-size: 12px;
    }

    .caption {
      color: white;
      font-size: 15px;
    }

    #zoom {
      color: white;
      transform: translate(75px, 150px);
    }

    div.sidebar {	
      position: absolute;
      text-align: left;			
      width: 25%;
      height: 100vh;
      color: #E6AB02;		
      font: 18px "Didact Gothic";		
      background: #2C251E;	
      border: 0px;		
      padding: 30px;			
      pointer-events: none;			
    }

    body {
        display: flex;
        flex-direction: row;
    }

    text {
        font-family: 'Didact Gothic', sans-serif; 
    }

    #blurb {
        display: flex;
        flex-direction: column;
        width: 60%;
        padding: 10px;
    }

    .axis line{
        stroke: white;
    }

    .y-axis line{
      stroke: white;
      visibility: hidden;
    }

    .axis path{
        stroke: white;
    }

    .axis text{
      font-size: 16px;
      text-transform: lowercase;
      stroke: white;
    }

    .legendSize text {
      stroke: white;
      opacity: 100%;
    }

    #container {
      display: flex;
      flex-direction: column;
    }

    #heading {
      display: flex;
      flex-direction: row;
    }

    .nav-option {
      color: #7E5E29 !important;
      font-size: 24px;
      text-decoration: none !important;
    }

    .selected-nav-option {
      color: #E6AB02 !important;
      font-size: 26px;
      font-weight: 600;
      text-decoration: none !important;
    }

  </style>
</head>
<body>
    <!DOCTYPE html>
    <meta charset="utf-8">
    
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>
    
    <!-- Create a div where the graph will take place -->
    <div class="row">
      <div class="col-sm-3 p-4" style="background-color: #383838;">
        <div id="heading">
          <img src="./images/popcorn.png" width="120" height="120">
          <div id="blurb">
            <h1>reception</h1>
            <h2>
                Pulling from the top 1000 movies by adjusted gross revenue, we can explore the relationship between cast diversity and various metrics of reception, including IMDB metascore and gross lifetime revenue.
                Hover over circles to see more information about individual movies.
            </h2>
            <!-- <div class="sources">
              <i>
                Adapted from: <a href="https://www.d3-graph-gallery.com/graph/scatter_basic.html">D3 Scatterplot Tutorial</a> <br>
                Data from: <a href="https://www.kaggle.com/carolzhangdc/imdb-5000-movie-dataset">IMDB Top 5000 Dataset</a>, 
                <a href="https://www.nndb.com/">NNDB</a>,
                Image from: <a href="https://favpng.com/png_view/popcorn-popcorn-icon-design-icon-png/UP1B5p7K">source</a>
              </i>
            </div> -->
          </div>
        </div>
        <div class="p-3 explore-section">
          <div class="nav-options">
            <a class="nav-option" href="oscars.html">awards</a>
            <br/>
            <a href="reception.html" class="selected-nav-option">reception</a>
            <br/>
            <a href="index.html" class="nav-option">back to home</a>
          </div>
        </div>
      </div>
      <div class="col-sm-9">
        <div id="main">
          <div id="legend"></div>
          <div id="graph"></div>
        </div>   
      </div>
    </div>
   
    
  
  <!-- JAVASCRIPT -->
  <script>

    // sets dimensions
    var margin = {top: 10, right: 60, bottom: 60, left: 60},
        width = 1100 - margin.left - margin.right,
        height = 900 - margin.top - margin.bottom;
    
    var legendWidth = 300;
    var legendHeight = 150;

    // sets constants
    var goldColor = "#E6AB02"
    
    // defines graph svg
    var svg = d3.select("#graph")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");
    
    // defines tooltip div
    var metadataSidebar = d3.select("body").append("div")	
        .attr("class", "sidebar")				
        .style("opacity", 0);

    // x-position scale
    var x = d3.scaleLinear()
        .domain([0, 1])
        .range([ 0, width ]);
    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .attr("class", "axis")
        .call(d3.axisBottom(x))
        .call(g => g.select(".domain").remove());

    svg.append("text")             
        .attr("transform",
            "translate(" + (width/2) + " ," + 
                        (height + margin.top + 30) + ")")
        .style("text-anchor", "middle")
        .style("stroke", "white")
        .text("% white cast");

    // y-position scale
    var decades = ["1920s", "1930s", "1940s", "1950s", "1960s", "1970s", "1980s", "1990s", "2000s", "2010s"].reverse()
    var y = d3.scaleBand()
        .padding(0.4)
        .domain(decades)
        .range([ height, 0 ]);
    svg.append("g")
        .attr("class", "axis y-axis")
        .call(d3.axisLeft(y))
        .call(g => g.select(".domain").remove());
    
    // background bars
    svg.selectAll("bar")
      .data(decades)
        .enter()
          .append("rect")
            .style("fill", "#383838")
            .attr("rx", 6)
            .attr("ry", 6)
            .attr("x", 0)
            .attr("width", x(1))
            .attr("y", function(d) { return y(d); })
            .attr("height", y.bandwidth())
    // horizontal lines through background bars
    svg.selectAll("bar")
      .data(decades)
        .enter()
          .append('line')
            .style("stroke", "white")
            .style("stroke-width", 1)
            .style("opacity", 0.15)
            .attr("x1", 0)
            .attr("y1", function(d) {return y(d) + y.bandwidth() / 2})
            .attr("x2", x(1))
            .attr("y2", function(d) {return y(d) + y.bandwidth() / 2})
    // vertical lines through background bars
    var percentWhiteTicks = [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1]
    svg.selectAll("bar")
      .data(percentWhiteTicks)
        .enter()
          .append('line')
            .style("stroke", "rgb(29, 28, 28)")
            .style("stroke-width", 2.5)
            .attr("x1", d => x(d))
            .attr("y1", 0)
            .attr("x2", d => x(d))
            .attr("y2", height)
    
    function nFormatter(num, digits) {
      var si = [
        { value: 1, symbol: "" },
        { value: 1E3, symbol: "k" },
        { value: 1E6, symbol: "M" },
        { value: 1E9, symbol: "B" },
        { value: 1E12, symbol: "T" },
        { value: 1E15, symbol: "P" },
        { value: 1E18, symbol: "E" }
      ];
      var rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
      var i;
      for (i = si.length - 1; i > 0; i--) {
        if (num >= si[i].value) {
          break;
        }
      }
      return (num / si[i].value).toFixed(digits).replace(rx, "$1") + si[i].symbol;
    }

    // radius scale
    var rScale = d3.scaleLinear()
        .domain([0, 1900000000]) // hardset from worldwide gross income max
        .range([2, 20]);

    // size-based legend for revenue
    var legendSvg = d3.select("#legend")
        .append("svg")
            .attr("width", legendWidth)
            .attr("height", legendHeight);
           
    legendSvg.append("g")
        .attr("class", "legendSize")
        .attr("transform", "translate(0, 50)")
        .style("fill", goldColor);

    var legendSize = d3.legendSize()
        .scale(rScale)
        .shape('circle')
        .shapePadding(60)
        .labelFormat(d => nFormatter(d,1))
        .labelOffset(20)
        .title('adjusted lifetime revenue ($)')
        .orient('horizontal');
    
    legendSvg.select(".legendSize")
        .call(legendSize);
    
    d3.csv("./datasets/movie_distributions_top_1000_gross.csv", function(all_data) {
      // filter out top 50 per decade
      var data = []
      for (let i = 0; i < decades.length; i++) {
        var decadePrefix = decades[i].substring(0,3)
        var moviesInDecade = all_data.filter(d => d.year.substring(0,3) == decadePrefix)
        // sort movies by gross
        moviesInDecade.sort((a,b) => (a.adjusted_lifetime_gross < b.adjusted_lifetime_gross) ? 1 : -1)
        data.push(...moviesInDecade.slice(0,30)) // take top 30 movies
      }
      console.log('data', data, data.length)
      

      function getHtmlForSidebar(data) {
        // console.log(data.budget, intToString(data.worlwide_gross_income))
        // genre, budget, metascore, gross worldwide / us, percent distribution 
        var header = "<h3>" + data.original_title + " (" + data.year + ")" + "</h3>"
        var genre = "<div>Genre: " + data.genre + "</div>"
        var budget = "<div>Budget: " + nFormatter(data.budget,1) + "</div>"
        var metascore = "<div>IMDB metascore: " + data.metascore + "/100</div>"
        var gross = "<div>Worldwide gross revenue: " + nFormatter(data.adjusted_lifetime_gross, 1) + "</div>"
        var breaks = "<br><br>"
        var diversityText = "<div> Of the 15 most important actors in the film, the race distribution was: </div>"
        var white = "<div>" + Math.round(data.percent_white * 1000) / 10 + "% white"
        var black = "<div>" + Math.round(data.percent_black * 1000) / 10 + "% black"
        var hispanic = "<div>" + Math.round(data.percent_hispanic * 1000) / 10 + "% hispanic"
        var asian = "<div>" + Math.round(data.percent_asian * 1000) / 10 + "% asian"
        var other = "<div>" + Math.round(data.percent_other * 1000) / 10 + "% other"

        return header + genre + budget + metascore + gross + breaks + diversityText + white + black + hispanic + asian + other
      }

      // parse the data
      for (i = 0; i < data.length; i++) {
          data[i].budget = parseFloat(data[i].budget.replace('$', ''));
          data[i].usa_gross_income = parseFloat(data[i].usa_gross_income.replace('$', ''));
          data[i].adjusted_lifetime_gross = parseFloat(data[i].adjusted_lifetime_gross.substring(1,).replace(/,/g, ''));
      }

      // add scatterplot dots
      var node = svg.append('g')
      .selectAll("circle")
      .data(data)
      .enter()
      .append("circle")
        .attr("cx", d => x(d.percent_white))
        .attr("cy", d => {return y(d.year.substring(0,3) + "0s") + y.bandwidth() / 2})
        .attr("r", d => rScale(parseFloat(d.adjusted_lifetime_gross)))
        .style("fill", goldColor)
        .style("stroke", "#383838")
        .style("stroke-width", 1.5)
        .on("mouseover", function(d) {		
            metadataSidebar.transition()		
                .duration(200)		
                .style("opacity", 1);		
            metadataSidebar.html(
              getHtmlForSidebar(d)
            )
              .style("left", "0px")		
              .style("top", "0px");	
        })					
        .on("mouseout", function(d) {		
            metadataSidebar.transition()		
                .duration(500)		
                .style("opacity", 0);	
        });
        
      // physics for dots along the line
      // Features of the forces applied to the nodes:
      var simulation = d3.forceSimulation()
          .force('x', d3.forceX().x(function(d) {
            // return xCenter[d.category];
            return x(d.percent_white);
          }).strength(0.4))
          .force('y', d3.forceY().y(function(d) {
            return y(d.year.substring(0,3) + "0s") + y.bandwidth() / 2;
          }).strength(0.4))
          .force('charge', d3.forceManyBody().strength(3))
          .force('collision', d3.forceCollide().radius(function(d) {
            return rScale(parseFloat(d.adjusted_lifetime_gross));
          }))

      // Apply these forces to the nodes and update their positions.
      // Once the force algorithm is happy with positions ('alpha' value is low enough), simulations will stop.
      simulation
          .nodes(data)
          .on("tick", function(d){
            node
                .attr("cx", function(d){ return d.x; })
                .attr("cy", function(d){ return d.y; })
          }); 
          })
    </script>
</body>